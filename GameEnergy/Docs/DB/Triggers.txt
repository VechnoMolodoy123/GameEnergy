SELECT * FROM sys.triggers;

CREATE TRIGGER trg_CalculateDiscountedPrice
ON [dbo].[Games]
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE g
    SET DiscountedPrice = 
        CASE 
            WHEN i.Discount IS NULL OR i.Discount <= 0 THEN i.Price
            WHEN i.Discount >= 100 THEN 1  -- минимум 1 копейка
            ELSE i.Price * (100 - i.Discount) / 100  -- целочисленное деление
        END
    FROM [dbo].[Games] g
    INNER JOIN inserted i ON g.GameID = i.GameID;
END;

CREATE TRIGGER trg_UpdateAverageRatingAfterInsert
ON [dbo].[Rating]
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE g
    SET AverageRating = (
        SELECT AVG(r.Rating * 1.0)
        FROM [dbo].[Rating] r
        WHERE r.GameID = g.GameID
    )
    FROM [dbo].[Games] g
    INNER JOIN inserted i ON g.GameID = i.GameID;
END;

CREATE TRIGGER trg_UpdateAverageRatingAfterDelete
ON [dbo].[Rating]
AFTER DELETE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE g
    SET AverageRating = COALESCE(
        (SELECT AVG(r.Rating * 1.0) FROM [dbo].[Rating] r WHERE r.GameID = g.GameID),
        0.00
    )
    FROM [dbo].[Games] g
    INNER JOIN deleted d ON g.GameID = d.GameID;
END;

CREATE TRIGGER trg_UpdateAverageRatingAfterUpdate
ON [dbo].[Rating]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    IF UPDATE(Rating)
    BEGIN
        UPDATE g
        SET AverageRating = (
            SELECT AVG(r.Rating * 1.0)
            FROM [dbo].[Rating] r
            WHERE r.GameID = g.GameID
        )
        FROM [dbo].[Games] g
        INNER JOIN inserted i ON g.GameID = i.GameID;
    END
END;

CREATE TRIGGER trg_UpdateOrderTotal
ON [dbo].[OrderItems]
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Собираем OrderID из затронутых строк
    DECLARE @OrderIDs TABLE (OrderID INT);
    INSERT INTO @OrderIDs
    SELECT OrderID FROM inserted
    UNION
    SELECT OrderID FROM deleted;

    -- Обновляем TotalAmount в Orders
    UPDATE o
    SET TotalAmount = ISNULL((
        SELECT SUM(oi.PriceAtPurchase)
        FROM [dbo].[OrderItems] oi
        WHERE oi.OrderID = o.OrderID
    ), 0)
    FROM [dbo].[Orders] o
    INNER JOIN @OrderIDs t ON o.OrderID = t.OrderID;
END;